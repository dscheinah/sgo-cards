<template>
    <h2>Treasures</h2>
    <details>
        <summary>View your treasures and activate up to four.</summary>
        <ul>
            <li>You need to identify a treasure before it can be used.</li>
            <li>Effects are applied during battles and are not shown in the stats.</li>
            <li>Only active treasures provide effects.</li>
            <li>You can have up to four active treasures at a time.</li>
            <li>All identified treasures can be leveled up.</li>
            <li>The level is displayed as a number with a plus sign.</li>
            <li>Some treasures consume charges and need to be refilled.</li>
            <li>Remaining charges are shown as a multiplier.</li>
            <li>There is a limit to how many treasures you can find.</li>
        </ul>
    </details>
    <form id="game-treasure">
        <table class="sx-list">
            <tbody></tbody>
        </table>
        <div class="sx-actions">
            <button type="submit"><span class="sx-button-icon">ğŸ’¾</span> Apply</button>
            <span id="game-treasure-counter"></span>
        </div>
    </form>
</template>
<script type="module">
    import {helper, page, state} from '../../js/app.js';

    let user = state.get('user');
    let round = state.get('round');

    page.register('game-treasure', ({render, show, action, listen}) => {
        render(() => {
            if (!round) {
                return;
            }
            helper.list('#game-treasure tbody', round['treasures'], (treasure) => {
                const tr = helper.create('tr');
                const charges = treasure['charges'] ? `${treasure['charges']} x ` : ''
                const level = treasure.level ? ` +${treasure.level}` : ''
                const description = treasure['trigger']
                    ? `${treasure['descriptions']['identify']} (${treasure['trigger']})`
                    : `${treasure['descriptions']['effect']}<br/>${treasure['descriptions'].level}`;
                const inactive = `${treasure['trigger'] ? 'game-treasure-inactive' : ''}`;
                tr.innerHTML = `
                    <td class="game-treasure-checkbox ${inactive}">
                        <input type="checkbox" name="ids[]" value="${treasure.id}" ${treasure.active ? 'checked' : ''} aria-label="active">
                    </td>
                    <td class="game-treasure-icon ${inactive}">${treasure.icon}</td>
                    <td>
                        <strong class="${inactive}">${charges}${treasure.name}${level}</strong><br/>
                        ${description}
                    </td>
                `
                return tr;
            });
            const length = helper.elements('#game-treasure input:checked').length;
            helper.set('#game-treasure-counter', 'innerHTML', `${length} ${length === 1 ? 'treasure' : 'treasures'} selected`);
        });

        show(() => {
            state.dispatch('notify-treasure', round);
        });

        action('#game-treasure input', 'input', (event, target) => {
            const length = helper.elements('#game-treasure input:checked').length;
            if (length > 4) {
                target.checked = false;
            } else {
                helper.set('#game-treasure-counter', 'innerHTML', `${length} ${length === 1 ? 'treasure' : 'treasures'} selected`);
            }
        });

        action('#game-treasure', 'submit', (event, target) => {
            event.preventDefault();
            state.dispatch('loading', true);
            state.dispatch('treasure-activate', [user.id, new FormData(target), round['league'].id]);
        });

        listen('user', (payload) => {
            user = payload;
        });

        listen('round', (payload) => {
            round = payload;
        });

        listen('treasure-activate', () => {
            state.dispatch('loading', false);
            history.back();
        });
    });
</script>
<style>
    .game-treasure-checkbox {
        width: 1.5em;
    }

    .game-treasure-icon {
        width: 1em;
        font-size: 2em;
    }

    .game-treasure-inactive {
        opacity: .2;
    }
</style>
